# -*- coding: utf-8 -*-
"""QuantEdge Intelligence

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkmpljoOIvjbKUjTAM0G8OCGRZI-inXT
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from arch import arch_model
from datetime import datetime, timedelta

# --- LIGHT THEME UI ---
st.set_page_config(page_title="QuantPro Advisor", layout="wide")
st.markdown("""
    <style>
    .stApp { background-color: #f8fafc; color: #1e293b; }
    [data-testid="stMetricValue"] { color: #1e3a8a !important; font-weight: 800; }
    [data-testid="metric-container"] { 
        background-color: #ffffff; border: 1px solid #e2e8f0; 
        border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .valuation-card { 
        padding: 20px; border-radius: 12px; background-color: #ffffff; 
        border: 1px solid #e2e8f0; border-top: 4px solid #2563eb; 
        margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    .status-undervalued { color: #16a34a; font-weight: bold; }
    .status-overvalued { color: #dc2626; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# --- ASSET UNIVERSE ---
STOCKS = ["RELIANCE.NS", "TCS.NS", "HDFCBANK.NS", "INFY.NS", "SBIN.NS", "ICICIBANK.NS", "TATAMOTORS.NS"]

# --- SIDEBAR CONTROLS ---
st.sidebar.title("ðŸ› ï¸ Settings")
sel_stock = st.sidebar.selectbox("Select Asset", STOCKS)
lookback = st.sidebar.slider("Timeframe (Years)", 1, 15, 5)
rf_rate = st.sidebar.number_input("Risk Free Rate %", value=7.1) / 100

# --- DATA ENGINE ---
@st.cache_data
def get_full_data(ticker, yrs):
    start = datetime.now() - timedelta(days=yrs*365 + 300) 
    df = yf.download([ticker, "^NSEI", "^NSEBANK"], start=start.strftime('%Y-%m-%d'))['Close']
    if isinstance(df.columns, pd.MultiIndex):
        df.columns = df.columns.get_level_values(1)
    df = df.dropna(subset=[ticker]).ffill()
    return df, df.index[0]

data, listing_date = get_full_data(sel_stock, lookback)

if data is not None:
    # --- INITIALIZE ALL THREE TABS HERE ---
    tab1, tab2, tab3 = st.tabs(["ðŸ’Ž Valuation & Market", "ðŸ—ï¸ Structural Strength", "ðŸ”® Volatility & Strategy"])

    # --- TAB 1: VALUATION ENGINE ---
    with tab1:
        st.title(f"Valuation: {sel_stock}")
        returns = data.pct_change().dropna()
        avg_ret = returns[sel_stock].mean() * 252
        
        beta = (returns.cov().loc[sel_stock, "^NSEI"] * 252) / (returns["^NSEI"].var() * 252)
        mkt_ret = returns["^NSEI"].mean() * 252
        capm_exp = rf_rate + beta * (mkt_ret - rf_rate)
        
        m1, m2, m3 = st.columns(3)
        m1.metric("Avg Annual Return", f"{avg_ret:.2%}")
        m2.metric("Market Beta", f"{beta:.2f}")
        m3.metric("Exp. Return (CAPM)", f"{capm_exp:.2%}")

        cum_ret = (1 + returns).cumprod()
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=cum_ret.index, y=cum_ret[sel_stock], name="Stock", line=dict(color='#2563eb', width=3)))
        fig.add_trace(go.Scatter(x=cum_ret.index, y=cum_ret['^NSEI'], name="Nifty 50", line=dict(color='#94a3b8', dash='dot')))
        fig.update_layout(template="plotly_white", height=400)
        st.plotly_chart(fig, use_container_width=True)

    # --- TAB 2: TECHNICAL DNA ---
    with tab2:
        st.title(f"Price Structure: {sel_stock}")
        data['MA50'] = data[sel_stock].rolling(50).mean()
        data['MA200'] = data[sel_stock].rolling(200).mean()
        last_price = data[sel_stock].iloc[-1]
        
        st.subheader("1. The Institutional Filter (Moving Averages)")
        c1, c2, c3 = st.columns(3)
        with c1:
            status = "âœ… BULLISH" if last_price > data['MA200'].iloc[-1] else "âŒ BEARISH"
            st.metric("Trend vs 200-Day MA", status)
        with c2:
            is_golden = data['MA50'].iloc[-1] > data['MA200'].iloc[-1]
            st.metric("50/200 MA Cross", "ðŸ”¥ GOLDEN" if is_golden else "â„ï¸ DEATH")
        with c3:
            dist_high = (last_price / data[sel_stock].max()) - 1
            st.metric("Near 52-Wk High", f"{dist_high:.2%}")

        st.subheader("2. Price Memory (S/R Levels)")
        res = data[sel_stock].tail(20).max()
        supp = data[sel_stock].tail(20).min()
        fig_tech = go.Figure()
        fig_tech.add_trace(go.Scatter(x=data.tail(300).index, y=data[sel_stock].tail(300), name="Price", line=dict(color='#1e3a8a')))
        fig_tech.add_trace(go.Scatter(x=data.tail(300).index, y=data['MA200'].tail(300), name="200 MA", line=dict(color='#dc2626')))
        fig_tech.add_hline(y=res, line_dash="dash", line_color="green", annotation_text="Resistance")
        fig_tech.add_hline(y=supp, line_dash="dash", line_color="red", annotation_text="Support")
        fig_tech.update_layout(template="plotly_white", height=450)
        st.plotly_chart(fig_tech, use_container_width=True)

        st.subheader("3. Relative Strength vs Nifty")
        stock_30 = (data[sel_stock].iloc[-1] / data[sel_stock].iloc[-22]) - 1
        nifty_30 = (data['^NSEI'].iloc[-1] / data['^NSEI'].iloc[-22]) - 1
        rs = stock_30 - nifty_30
        if rs > 0:
            st.success(f"ðŸ’ª Stock is OUTPERFORMING the market by {rs:.2%} over the last 22 days.")
        else:
            st.error(f"âš ï¸ Stock is UNDERPERFORMING the market by {rs:.2%} over the last 22 days.")

    # --- TAB 3: VOLATILITY & STRATEGY PLAYBOOK ---
    with tab3:
        st.header("ðŸ”® Volatility Analysis & Strategy Playbook")
        
        # 1. GARCH Analysis
        st.subheader("1. GARCH (1,1) Volatility Clusters")
        returns_garch = 100 * data[sel_stock].pct_change().dropna()
        am = arch_model(returns_garch, vol='Garch', p=1, q=1, dist='t')
        res = am.fit(disp="off")
        
        col_v1, col_v2 = st.columns([1, 2])
        with col_v1:
            st.write("**Model Parameters**")
            st.write(res.params)
            forecast_vol = np.sqrt(res.forecast(horizon=252).variance.values[-1, :]) / 100
            st.metric("Predicted Annual Vol (Next Year)", f"{np.mean(forecast_vol)*np.sqrt(252):.2%}")
        
        with col_v2:
            fig_vol = go.Figure()
            fig_vol.add_trace(go.Scatter(x=res.conditional_volatility.index, y=res.conditional_volatility, 
                                         name="Conditional Volatility", line=dict(color='#f59e0b')))
            fig_vol.update_layout(template="plotly_white", title="Historical Volatility Clusters (GARCH)", height=300)
            st.plotly_chart(fig_vol, use_container_width=True)

        st.divider()

        # 2. 1-Year Forecast
        st.subheader("2. 1-Year Price Path Projection")
        last_price = data[sel_stock].iloc[-1]
        drift = returns_garch.mean() / 100
        future_dates = [data.index[-1] + timedelta(days=i) for i in range(1, 253)]
        
        np.random.seed(42)
        daily_vol = forecast_vol
        shocks = np.random.standard_normal(252)
        price_path = [last_price]
        for i in range(252):
            next_p = price_path[-1] * np.exp(drift + daily_vol[i] * shocks[i])
            price_path.append(next_p)
        
        df_forecast = pd.DataFrame({'Close': price_path[1:]}, index=future_dates)
        fig_path = go.Figure()
        fig_path.add_trace(go.Scatter(x=df_forecast.index, y=df_forecast['Close'], name="Projected Price", line=dict(color='#2563eb', width=3)))
        fig_path.update_layout(template="plotly_white", title="Forecasted Closing Prices (Next 252 Days)", height=400)
        st.plotly_chart(fig_path, use_container_width=True)

        st.divider()

        # 3. Strategy Configuration
        st.subheader("3. Strategy Customization & Backtest")
        strat_choice = st.selectbox("Select Strategy", ["SMA Crossover", "RSI Mean Reversion", "Golden Crossover"])
        
        if strat_choice == "SMA Crossover":
            p1 = st.slider("Fast SMA Period", 5, 50, 20)
            p2 = st.slider("Slow SMA Period", 20, 200, 50)
        elif strat_choice == "RSI Mean Reversion":
            p1 = st.slider("RSI Period", 7, 30, 14)
            p2 = st.slider("Oversold Level", 10, 40, 30)
        else: # Golden Cross
            p1, p2 = 50, 200
            st.info("Institutional Standard: 50-Day and 200-Day SMA used.")

        def run_engine(df, s_type, params):
            df = df.copy()
            if s_type in ["SMA Crossover", "Golden Crossover"]:
                df['F'] = df['Close'].rolling(params[0]).mean()
                df['S'] = df['Close'].rolling(params[1]).mean()
                df['Signal'] = np.where(df['F'] > df['S'], 1, 0)
            elif s_type == "RSI Mean Reversion":
                delta = df['Close'].diff()
                gain = (delta.where(delta > 0, 0)).rolling(params[0]).mean()
                loss = (-delta.where(delta < 0, 0)).rolling(params[0]).mean()
                rs = gain / (loss + 1e-9)
                df['RSI'] = 100 - (100 / (1 + rs))
                df['Signal'] = np.where(df['RSI'] < params[1], 1, 0)
            
            df['Ret'] = df['Close'].pct_change()
            df['Strat_Ret'] = df['Signal'].shift(1) * df['Ret']
            return df

        hist_bt = run_engine(data[[sel_stock]].rename(columns={sel_stock:'Close'}), strat_choice, [p1, p2])
        full_for_bt = pd.concat([data[[sel_stock]].tail(200).rename(columns={sel_stock:'Close'}), df_forecast])
        fore_bt = run_engine(full_for_bt, strat_choice, [p1, p2]).loc[df_forecast.index]

        # Results Table
        st.subheader("4. Historical vs Forecasted Performance")
        def get_metrics(df):
            ann_ret = df['Strat_Ret'].mean() * 252
            ann_vol = df['Strat_Ret'].std() * np.sqrt(252)
            sharpe = ann_ret / ann_vol if ann_vol != 0 else 0
            trades = df['Signal'].diff().abs().sum()
            return [f"{ann_ret:.2%}", f"{ann_vol:.2%}", round(sharpe, 2), int(trades)]

        metrics_df = pd.DataFrame({
            "Metric": ["Annual Return", "Annual Risk", "Sharpe Ratio", "Num. Trades"],
            "Historical": get_metrics(hist_bt),
            "Forecasted (1Y)": get_metrics(fore_bt)
        })
        st.table(metrics_df)

        # Forecast Signal Chart
        st.subheader("5. Forecasted Signal Map")
        fig_sig = go.Figure()
        fig_sig.add_trace(go.Scatter(x=fore_bt.index, y=fore_bt['Close'], name="Future Price", line=dict(color='#94a3b8', width=1)))
        buys = fore_bt[fore_bt['Signal'].diff() == 1]
        sells = fore_bt[fore_bt['Signal'].diff() == -1]
        fig_sig.add_trace(go.Scatter(x=buys.index, y=buys['Close'], mode='markers', name='BUY', marker=dict(symbol='triangle-up', size=12, color='#16a34a')))
        fig_sig.add_trace(go.Scatter(x=sells.index, y=sells['Close'], mode='markers', name='SELL', marker=dict(symbol='triangle-down', size=12, color='#dc2626')))
        fig_sig.update_layout(template="plotly_white", height=400)
        st.plotly_chart(fig_sig, use_container_width=True)

else:
    st.error("Could not fetch data.")
    
    
    
    
    







