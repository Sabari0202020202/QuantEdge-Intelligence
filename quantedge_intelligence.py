# -*- coding: utf-8 -*-
"""QuantEdge Intelligence

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkmpljoOIvjbKUjTAM0G8OCGRZI-inXT
"""
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from datetime import datetime
from scipy.stats import norm

# --- PAGE CONFIG ---
st.set_page_config(page_title="QuantEdge India", layout="wide", initial_sidebar_state="expanded")

# --- HIGH-CONTRAST UI THEME ---
st.markdown("""
    <style>
    /* Background and Main Text */
    .stApp {
        background-color: #050a14;
        color: #e0e0e0;
    }
    
    /* Sidebar styling */
    section[data-testid="stSidebar"] {
        background-color: #0b1426;
        border-right: 1px solid #1f2937;
    }
    
    /* Metrics Boxes - High Visibility */
    div[data-testid="stMetricValue"] {
        font-size: 1.8rem !important;
        font-weight: 700 !important;
        color: #ffffff !important;
    }
    div[data-testid="stMetricLabel"] {
        color: #94a3b8 !important; /* Soft grey for labels */
        font-size: 1rem !important;
        text-transform: uppercase;
    }
    [data-testid="metric-container"] {
        background-color: #111b2e;
        border: 1px solid #3b82f6;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    /* Headlines */
    h1, h2, h3 {
        color: #3b82f6 !important; /* Electric Blue */
        font-family: 'Inter', sans-serif;
    }
    
    /* Buttons */
    .stButton > button {
        background-color: #3b82f6;
        color: white;
        border-radius: 8px;
        width: 100%;
        border: none;
    }
    
    /* Divider color */
    hr {
        border-top: 1px solid #1f2937;
    }
    </style>
    """, unsafe_allow_html=True)

# --- SIDEBAR CONTROLS ---
st.sidebar.title("üîç Parameters")
ticker_input = st.sidebar.text_input("NSE/BSE Ticker", "RELIANCE.NS")
capital = st.sidebar.number_input("Capital (‚Çπ)", value=1000000)
risk_per_trade = st.sidebar.slider("Risk per Trade (%)", 0.1, 5.0, 1.0) / 100

# --- DATA ENGINE ---
@st.cache_data
def load_data(ticker):
    try:
        data = yf.download(ticker, start="2000-01-01")
        if data.empty: return None
        # Handle Multi-index columns if necessary
        data.columns = [c[0] if isinstance(c, tuple) else c for c in data.columns]
        return data
    except:
        return None

data = load_data(ticker_input)

if data is not None:
    # Basic Calculations
    data['Returns'] = data['Close'].pct_change()
    window = 20
    data['SMA20'] = data['Close'].rolling(window).mean()
    data['Std'] = data['Close'].rolling(window).std()

    # --- DASHBOARD HEADER ---
    st.title(f"üìà {ticker_input} Analytics")
    
    # --- MODULE 1: REGIME & VOLATILITY ---
    c1, c2, c3 = st.columns(3)
    
    # Calculation for Vol & Regime
    vol = data['Returns'].rolling(20).std().iloc[-1] * np.sqrt(252)
    z_score = (data['Returns'].iloc[-1] - data['Returns'].rolling(100).mean().iloc[-1]) / data['Returns'].rolling(100).std().iloc[-1]
    
    with c1:
        st.metric("Annual Volatility", f"{vol:.2%}")
    with c2:
        regime_label = "Trending" if data['Close'].iloc[-1] > data['SMA20'].iloc[-1] else "Mean Reverting"
        st.metric("Market Regime", regime_label)
    with c3:
        st.metric("Anomaly Score", f"{z_score:.2f} œÉ")

    # --- MAIN CHART ---
    fig = go.Figure()
    fig.add_trace(go.Scatter(x=data.index, y=data['Close'], name="Price", line=dict(color='#3b82f6', width=2)))
    fig.add_trace(go.Scatter(x=data.index, y=data['SMA20'], name="20 SMA", line=dict(color='#94a3b8', dash='dot')))
    fig.update_layout(
        template="plotly_dark",
        paper_bgcolor='rgba(0,0,0,0)',
        plot_bgcolor='rgba(0,0,0,0)',
        margin=dict(l=0, r=0, t=30, b=0),
        legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1)
    )
    st.plotly_chart(fig, use_container_width=True)

    # --- MODULE 2: POSITION SIZING & RISK ---
    st.subheader("üõ°Ô∏è Risk Management")
    r1, r2, r3 = st.columns(3)
    
    # ATR Calculation
    high_low = data['High'] - data['Low']
    true_range = high_low.rolling(14).mean().iloc[-1]
    
    risk_amt = capital * risk_per_trade
    shares = int(risk_amt / (true_range * 2)) if true_range > 0 else 0
    
    with r1:
        st.metric("Risk Amount", f"‚Çπ{risk_amt:,.0f}")
    with r2:
        st.metric("ATR Stop (2x)", f"‚Çπ{true_range*2:.2f}")
    with r3:
        st.metric("Suggested Units", f"{shares} Qty")

    # --- MODULE 3: STRATEGY BACKTEST ---
    st.subheader("üß™ Backtest: SMA Crossover")
    fast = st.sidebar.number_input("Fast SMA", 5, 50, 20)
    slow = st.sidebar.number_input("Slow SMA", 20, 200, 50)
    
    df_bt = data[['Close']].copy()
    df_bt['F'] = df_bt['Close'].rolling(fast).mean()
    df_bt['S'] = df_bt['Close'].rolling(slow).mean()
    df_bt['Sig'] = np.where(df_bt['F'] > df_bt['S'], 1, 0)
    df_bt['Strat_Ret'] = df_bt['Sig'].shift(1) * data['Returns']
    
    cum_strat = (1 + df_bt['Strat_Ret']).prod() - 1
    
    fig_bt = px.line(df_bt, x=df_bt.index, y=(1+df_bt['Strat_Ret']).cumprod(), 
                     title="Equity Curve", color_discrete_sequence=['#3b82f6'])
    fig_bt.update_layout(template="plotly_dark", paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')
    st.plotly_chart(fig_bt, use_container_width=True)
    
    st.sidebar.success(f"Total Strategy Return: {cum_strat:.2%}")

else:
    st.warning("‚ö†Ô∏è Enter a valid ticker to load the analysis dashboard.")
