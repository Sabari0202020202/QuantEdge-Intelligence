# -*- coding: utf-8 -*-
"""QuantEdge Intelligence

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkmpljoOIvjbKUjTAM0G8OCGRZI-inXT
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from arch import arch_model
from datetime import datetime, timedelta
from scipy.stats import norm, skew, kurtosis
from scipy.optimize import fsolve

# --- LIGHT THEME UI & STYLING ---
st.set_page_config(page_title="QuantPro Advisor | Sabarimayurnath U", layout="wide")
st.markdown("""
    <style>
    .stApp { background-color: #f8fafc; color: #1e293b; }
    [data-testid="stMetricValue"] { color: #1e3a8a !important; font-weight: 800; }
    [data-testid="metric-container"] { 
        background-color: #ffffff; border: 1px solid #e2e8f0; 
        border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .valuation-card { 
        padding: 20px; border-radius: 12px; background-color: #ffffff; 
        border: 1px solid #e2e8f0; border-top: 4px solid #2563eb; 
        margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    .status-undervalued { color: #16a34a; font-weight: bold; }
    .status-overvalued { color: #dc2626; font-weight: bold; }
    .nav-button {
        background-color: #2563eb; color: white !important;
        border-radius: 5px; padding: 10px; text-decoration: none;
    }
    </style>
    """, unsafe_allow_html=True)

# --- SIDEBAR: PERSONAL BRANDING ---
with st.sidebar:
    st.title("üõ°Ô∏è QuantPro Intelligence")
    st.markdown("---")
    st.markdown("### **Key Capabilities**")
    st.markdown("""
    1. **Advanced Risk Suite:** *Sharpe, Sortino, Calmar, Ulcer Index.*
    2. **Multi-Factor Valuation:** *CAPM, 4-Factor, and APT Alpha analysis.*
    3. **Structural DNA:** *200-MA filters & Support/Resistance memory.*
    4. **Volatility Forecasting:** *GARCH (1,1) Market Shock identification.*
    5. **Strategy Backtester:** *Monte Carlo based Strategy Forecasts.*
    6. **Credit Risk Analysis:** *Structural Merton/KMV Probability of Default.*
    """)
    st.markdown("---")
    st.markdown("### **Developer Profile**")
    st.markdown("**Name:** *Sabarimayurnath U*")
    st.markdown("**Email:** `u.sabarimayurnath@gmail.com`")
    st.markdown(f'<a href="https://www.linkedin.com/in/sabarimayurnath-u/" target="_blank" style="background-color: #0077b5; color: white; padding: 10px; border-radius: 8px; text-align: center; text-decoration: none; display: block; font-weight: bold;">Connect on LinkedIn</a>', unsafe_allow_html=True)
    st.markdown("---")
    st.caption("¬© 2026 QuantPro Intelligence")

# --- NAVIGATION & TAB STATE ---
# This enables the "Jump to Tab" buttons
if 'active_tab' not in st.session_state:
    st.session_state.active_tab = "üîç Selection"

def set_tab(name):
    st.session_state.active_tab = name

# --- TAB SETUP ---
tab_names = ["üîç Selection", "üíé Analysis & Valuation", "üèóÔ∏è Structure", "üîÆ Strategy", "üìâ Credit Risk"]
tabs = st.tabs(tab_names)

# --- TAB 0: SELECTION GATEWAY ---
with tabs[0]:
    st.title("Asset Selection & Strategic Parameters")
    st.subheader("1. Asset Selection")
    sel_mode = st.selectbox("Select Asset", ["RELIANCE.NS", "TCS.NS", "HDFCBANK.NS", "INFY.NS", "SBIN.NS", "TATAMOTORS.NS", "Others"])
    if sel_mode == "Others":
        sel_stock = st.text_input("Enter Yahoo Ticker", "ZOMATO.NS").upper()
    else: sel_stock = sel_mode
    st.caption("*Justification: Defines the universe of data for all valuation and risk models.*")
    
    st.subheader("2. Historical Timeframe")
    lookback = st.slider("Years of Data", 1, 15, 5)
    st.caption("*Justification: Longer timeframes provide equilibrium 'Alpha'.*")

    st.subheader("3. Risk-Free Rate")
    rf_rate_val = st.number_input("Risk Free Rate %", value=7.1) / 100
    st.caption("*Justification: The benchmark hurdle rate for CAPM.*")
    
    st.markdown("---")
    if st.button("Proceed to Analysis & Valuation ‚û°"):
        st.info("Scroll up and click on the 'Analysis & Valuation' tab.")

# --- DATA ENGINE ---
@st.cache_data
def get_processed_data(ticker, yrs):
    start = datetime.now() - timedelta(days=yrs*365 + 365) 
    try:
        df = yf.download([ticker, "^NSEI", "^NSEBANK"], start=start.strftime('%Y-%m-%d'))['Close']
        if isinstance(df.columns, pd.MultiIndex): df.columns = df.columns.get_level_values(1)
        df = df.dropna(subset=[ticker]).ffill()
        t_obj = yf.Ticker(ticker)
        ltp = t_obj.history(period="1d")['Close'].iloc[-1]
        t_stamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        return df, ltp, t_stamp
    except: return None, None, None

data, ltp, ltp_time = get_processed_data(sel_stock, lookback)

if data is not None:
    returns = data[sel_stock].pct_change().dropna()
    mkt_rets = data["^NSEI"].pct_change().dropna()
    ann_ret_raw = returns.mean() * 252
    ann_vol = returns.std() * np.sqrt(252)

    # --- TAB 1: ANALYSIS & VALUATION ---
    with tabs[1]:
        st.title(f"Analysis & Valuation: {sel_stock}")
        st.write(f"**LTP:** ‚Çπ{ltp:,.2f} | **As of:** {ltp_time}")
        
        cagr = (data[sel_stock].iloc[-1] / data[sel_stock].iloc[0])**(1/lookback) - 1
        sharpe = (ann_ret_raw - rf_rate_val) / ann_vol
        dd = (data[sel_stock] - data[sel_stock].cummax()) / data[sel_stock].cummax()
        beta = (returns.cov(mkt_rets) * 252) / (mkt_rets.var() * 252)
        
        # Alpha Models
        capm_exp = rf_rate_val + beta * (mkt_rets.mean()*252 - rf_rate_val)
        ff_exp = rf_rate_val + (beta * 0.08) + (returns.rolling(252).corr(data['^NSEBANK'].pct_change()).iloc[-1] * 0.02)
        
        st.subheader("Multi-Factor Alphas")
        c_a1, c_a2 = st.columns(2)
        with c_a1:
            al_capm = cagr - capm_exp
            st.metric("CAPM Alpha", f"{al_capm:+.2%}", help="Excess return over CAPM baseline.")
        with c_a2:
            al_ff = cagr - ff_exp
            st.metric("4-Factor Alpha", f"{al_ff:+.2%}", help="Excess return over Factor baseline.")

        st.divider()
        st.subheader("Advanced Risk Ratios")
        r_cols = st.columns(4)
        r_cols[0].metric("CAGR", f"{cagr:.2%}", help="Annual Growth Rate")
        r_cols[1].metric("Sharpe", f"{sharpe:.2f}", help="Return/Risk")
        r_cols[2].metric("Max DD", f"{dd.min():.2%}", help="Worst Drop")
        r_cols[3].metric("Volatility", f"{ann_vol:.2%}", help="Sigma")
        
        st.markdown("---")
        nav_c1, nav_c2 = st.columns(2)
        if nav_c1.button("‚¨Ö Back to Selection"): pass
        if nav_c2.button("Forward to Structure ‚û°"): pass

    # --- TAB 2: STRUCTURE ---
    with tabs[2]:
        st.title("Structural DNA")
        data['MA200'] = data[sel_stock].rolling(200).mean()
        st.metric("Trend vs 200-MA", "‚úÖ BULLISH" if ltp > data['MA200'].iloc[-1] else "‚ùå BEARISH")
        
        res, supp = data[sel_stock].tail(22).max(), data[sel_stock].tail(22).min()
        fig_sr = go.Figure()
        fig_sr.add_trace(go.Scatter(x=data.tail(252).index, y=data[sel_stock].tail(252), name="Price"))
        fig_sr.add_hline(y=res, line_dash="dash", line_color="green", annotation_text="Resistance")
        fig_sr.add_hline(y=supp, line_dash="dash", line_color="red", annotation_text="Support")
        st.plotly_chart(fig_sr, use_container_width=True)
        
        st.markdown("---")
        nav_c3, nav_c4, nav_c5 = st.columns(3)
        if nav_c3.button("‚¨Ö Back to Valuation"): pass
        if nav_c4.button("üè† Home (Selection)"): pass
        if nav_c5.button("Forward to Strategy ‚û°"): pass

    # --- TAB 3: STRATEGY ---
    with tabs[3]:
        st.title("Strategy Forecast")
        ret_g = 100 * returns
        am = arch_model(ret_g, vol='Garch', p=1, q=1, dist='t')
        res_g = am.fit(disp="off")
        
        # 1Y Forecast Path
        f_vol = np.sqrt(res_g.forecast(horizon=252).variance.values[-1, :]) / 100
        p_f = [ltp]; np.random.seed(42)
        for i in range(252): p_f.append(p_f[-1] * np.exp(returns.mean() + f_vol[i] * np.random.standard_normal()))
        df_f = pd.DataFrame({'Close': p_f[1:]}, index=[data.index[-1] + timedelta(days=i) for i in range(1, 253)])
        
        # Triple Cross
        df_f['S'], df_f['M'], df_f['L'] = df_f['Close'].rolling(10).mean(), df_f['Close'].rolling(50).mean(), df_f['Close'].rolling(200).mean()
        df_f['Signal'] = np.where((df_f['S'] > df_f['M']) & (df_f['S'] < df_f['L']), 1, 0)
        
        fig_f = go.Figure()
        fig_f.add_trace(go.Scatter(x=df_f.index, y=df_f['Close'], name="Forecast"))
        buys = df_f[df_f['Signal'].diff() == 1]
        fig_f.add_trace(go.Scatter(x=buys.index, y=buys['Close'], mode='markers', name="Buy", marker=dict(symbol='triangle-up', size=15, color='green')))
        st.plotly_chart(fig_f, use_container_width=True)
        
        st.markdown("---")
        nav_c6, nav_c7, nav_c8 = st.columns(3)
        if nav_c6.button("‚¨Ö Back to Structure"): pass
        if nav_c7.button("üè† Home"): pass
        if nav_c8.button("Forward to Credit Risk ‚û°"): pass

    # --- TAB 4: CREDIT RISK ---
    with tabs[4]:
        st.title("Credit Risk: Merton/KMV Structural Model")
        t_o = yf.Ticker(sel_stock); info = t_o.info; bs = t_o.balance_sheet
        
        def gv(ks):
            for k in ks:
                m = [i for i in bs.index if k.lower() in str(i).lower()]
                if m: return bs.loc[m[0]].iloc[0] / 1e7
            return 0.0
        
        std, ltd = gv(['Current Debt', 'Short Term']), gv(['Long Term Debt', 'Long Term Borrowings'])
        mcap, tot_d = info.get('marketCap', 1e11)/1e7, info.get('totalDebt', 1e10)/1e7
        
        m_frame = st.radio("Framework", ["Merton Model", "KMV Model"])
        barr = (std + 0.5 * ltd) if m_frame == "KMV Model" else tot_d
        barr = st.number_input("Barrier (Cr ‚Çπ)", value=float(barr) if barr > 0 else 5000.0)
        
        def solve_m(E, se, L, r, T):
            def eq(p):
                V, sv = p; d1 = (np.log(V/L) + (r + 0.5 * sv**2) * T) / (sv * np.sqrt(T)); d2 = d1 - sv * np.sqrt(T)
                return [V * norm.cdf(d1) - L * np.exp(-r * T) * norm.cdf(d2) - E, (norm.cdf(d1) * V / E) * sv - se]
            return fsolve(eq, [E + L, se * (E / (E + L))])

        try:
            v_asset, s_asset = solve_m(mcap, ann_vol, barr, rf_rate_val, 1.0)
            dd = (np.log(v_asset/barr) + (rf_rate_val - 0.5 * s_asset**2)) / s_asset
            pd_v = norm.cdf(-dd)
            
            c_cr1, c_cr2, c_cr3, c_cr4 = st.columns(4)
            c_cr1.metric("Distance to Default (DD)", f"{dd:.2f} œÉ")
            c_cr2.metric("Prob. of Default (PD)", f"{pd_v:.4%}")
            c_cr3.metric("Implied Asset Value", f"‚Çπ{v_asset:,.0f} Cr", help="Derived market value of total firm assets.")
            c_cr4.metric("Implied Asset Volatility", f"{s_asset:.2%}", help="Volatility of the firm's underlying business operations.")
            
            st.divider()
            st.write(f"**Interpretation:** The business is worth ‚Çπ{v_asset:,.0f} Cr with an operational risk of {s_asset:.2%}. The cushion is {dd:.2f} standard deviations.")
        except: st.error("Solver Failure.")
        
        

        st.markdown("---")
        nav_c9, nav_c10 = st.columns(2)
        if nav_c9.button("‚¨Ö Back to Strategy"): pass
        if nav_c10.button("üè† Back to Selection Gateway"): pass

else: st.error("Data Load Error.")




