# -*- coding: utf-8 -*-
"""QuantEdge Intelligence

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkmpljoOIvjbKUjTAM0G8OCGRZI-inXT
"""

import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from datetime import datetime, timedelta

# --- LIGHT THEME UI ---
st.set_page_config(page_title="QuantPro Valuation", layout="wide")
st.markdown("""
    <style>
    .stApp { background-color: #f8fafc; color: #1e293b; }
    [data-testid="stMetricValue"] { color: #1e3a8a !important; font-weight: 800; }
    [data-testid="metric-container"] { 
        background-color: #ffffff; border: 1px solid #e2e8f0; 
        border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .valuation-card { 
        padding: 20px; border-radius: 12px; background-color: #ffffff; 
        border: 1px solid #e2e8f0; border-top: 4px solid #2563eb; 
        margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    .status-undervalued { color: #16a34a; font-weight: bold; }
    .status-overvalued { color: #dc2626; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# --- RESILIENT DATA ENGINE ---
@st.cache_data
def get_unified_data(ticker, lookback_yrs):
    # Buffer to ensure we have enough data for moving averages/correlations
    start_date_req = datetime.now() - timedelta(days=lookback_yrs*365 + 50) 
    assets = [ticker, "^NSEI", "^NSEBANK", "NIFTY_IT.NS"]
    
    # Download with error handling
    try:
        raw_df = yf.download(assets, start=start_date_req.strftime('%Y-%m-%d'))['Close']
        if isinstance(raw_df.columns, pd.MultiIndex):
            raw_df.columns = raw_df.columns.get_level_values(1)
        
        # Clean data: Remove rows where the target stock is missing
        df = raw_df.dropna(subset=[ticker])
        first_valid = df.index[0]
        
        return df.ffill(), first_valid
    except Exception as e:
        st.error(f"Data Fetch Error: {e}")
        return None, None

# --- UI CONTROLS ---
st.title("ðŸ¦ Strategic Equity Valuation")

c1, c2, c3 = st.columns([2, 1, 1])
with c1:
    sel_stock = st.selectbox("Select Company", ["RELIANCE.NS", "TCS.NS", "HDFCBANK.NS", "INFY.NS", "SBIN.NS", "ICICIBANK.NS", "TATAMOTORS.NS"])
with c2:
    lookback = st.slider("Timeframe (Years)", 1, 10, 3) # Defaulted to 3
with c3:
    rf_rate = st.number_input("Risk Free Rate %", value=7.1) / 100

data, list_date = get_unified_data(sel_stock, lookback)

if data is not None and len(data) > 20: # Ensure at least a month of data exists
    # --- CALCULATION CORE ---
    returns = data.pct_change().dropna()
    
    # Annualization factor (252 days)
    actual_ann_ret = returns[sel_stock].mean() * 252
    actual_ann_vol = returns[sel_stock].std() * np.sqrt(252)

    # Beta Calculation (Market Sensitivity)
    cov = returns.cov() * 252
    mkt_var = returns['^NSEI'].var() * 252
    beta = cov.loc[sel_stock, '^NSEI'] / mkt_var
    mkt_ret = returns['^NSEI'].mean() * 252

    # Models
    capm_exp = rf_rate + beta * (mkt_ret - rf_rate)
    
    # Factor correlation betas (Resilient to small samples)
    corr = returns.corr()
    b_mkt = corr.loc[sel_stock, '^NSEI']
    b_bank = corr.loc[sel_stock, '^NSEBANK']
    b_it = corr.loc[sel_stock, 'NIFTY_IT.NS']
    
    # Logic: Risk Free + (Factor Beta * Factor Premium)
    # Using normalized premiums for Indian context
    ff_exp = rf_rate + (b_mkt * 0.08) + (b_bank * 0.02) + (b_it * 0.03)
    apt_exp = rf_rate + (b_mkt * 0.07) + (b_bank * 0.05)

    # --- DISPLAY ---
    col_left, col_right = st.columns([2, 1])
    
    with col_left:
        st.subheader("Performance vs Nifty 50")
        cum_ret = (1 + returns).cumprod()
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=cum_ret.index, y=cum_ret[sel_stock], name="Stock", line=dict(color='#2563eb', width=3)))
        fig.add_trace(go.Scatter(x=cum_ret.index, y=cum_ret['^NSEI'], name="Nifty 50", line=dict(color='#94a3b8', dash='dot')))
        fig.update_layout(template="plotly_white", margin=dict(l=0,r=0,t=20,b=0), height=400)
        st.plotly_chart(fig, use_container_width=True)

    with col_right:
        st.subheader("Key Stats")
        st.metric("Total Return (Period)", f"{(cum_ret[sel_stock].iloc[-1]-1):.2%}")
        st.metric("Annualized Vol", f"{actual_ann_vol:.2%}")
        st.metric("Beta (Systematic Risk)", f"{beta:.2f}")

    st.divider()
    st.subheader("Valuation Verdicts")
    v1, v2, v3 = st.columns(3)

    def draw_card(title, exp, actual):
        alpha = actual - exp
        v_text = "UNDERVALUED" if alpha > 0 else "OVERVALUED"
        v_class = "status-undervalued" if alpha > 0 else "status-overvalued"
        st.markdown(f"""
            <div class="valuation-card">
                <div style='color:#64748b; font-size:0.8rem;'>{title}</div>
                <div style='font-size:1.6rem; font-weight:700;'>{exp:.2%}</div>
                <div style='font-size:1rem;'>Alpha: <span class='{v_class}'>{alpha:+.2%}</span></div>
                <div class='{v_class}' style='margin-top:10px; border-top:1px solid #eee; padding-top:10px;'>{v_text}</div>
            </div>
        """, unsafe_allow_html=True)

    with v1: draw_card("CAPM Expected Return", capm_exp, actual_ann_ret)
    with v2: draw_card("FF 4-Factor (Synthetic)", ff_exp, actual_ann_ret)
    with v3: draw_card("APT Factor Model", apt_exp, actual_ann_ret)

else:
    st.warning("Insufficient data for the selected timeframe. Try increasing the years or selecting a different stock.")
