# -*- coding: utf-8 -*-
"""QuantEdge Intelligence

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkmpljoOIvjbKUjTAM0G8OCGRZI-inXT
"""
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from arch import arch_model
from datetime import timedelta

# --- THEME & CONFIG ---
st.set_page_config(page_title="QuantPro India Forecast", layout="wide")

st.markdown("""
    <style>
    .stApp { background-color: #050a14; color: #ffffff; }
    [data-testid="stMetricValue"] { color: #ffffff !important; font-size: 2rem !important; }
    [data-testid="metric-container"] { 
        background-color: #111827; border: 1px solid #3b82f6; border-radius: 12px; 
    }
    h1, h2, h3 { color: #60a5fa !important; border-bottom: 1px solid #1e293b; padding-bottom: 10px; }
    .stTable { background-color: #0f172a; }
    </style>
    """, unsafe_allow_html=True)

# --- STOCK LIST ---
STOCKS = {"RELIANCE.NS": "Reliance", "TCS.NS": "TCS", "HDFCBANK.NS": "HDFC Bank", "INFY.NS": "Infosys", "SBIN.NS": "SBI"}

@st.cache_data
def get_historical(ticker):
    data = yf.download(ticker, start="2015-01-01")
    data.columns = [c[0] if isinstance(c, tuple) else c for c in data.columns]
    return data

# --- MAIN APP ---
st.title("ðŸ“ˆ 1-Year Strategic Price Forecast & Playbook")
sel_stock = st.selectbox("Select Asset", options=list(STOCKS.keys()), format_func=lambda x: STOCKS[x])
hist_data = get_historical(sel_stock)

if hist_data is not None:
    # --- 1. GARCH VOLATILITY & PRICE PROJECTION ---
    returns = 100 * hist_data['Close'].pct_change().dropna()
    model = arch_model(returns, vol='Garch', p=1, q=1)
    res = model.fit(disp="off")
    
    # Forecast 252 days (1 Trading Year)
    forecast_horizon = 252
    fc = res.forecast(horizon=forecast_horizon)
    # Annualized Vol from GARCH
    forecast_vol = np.sqrt(fc.variance.values[-1, :]) / 100 
    
    # Generate Projected Prices (GBM Model)
    last_price = hist_data['Close'].iloc[-1]
    drift = returns.mean() / 100
    
    # Create the time series for forecast
    future_dates = [hist_data.index[-1] + timedelta(days=i) for i in range(1, forecast_horizon + 1)]
    # Simplified projection: Price * cumulative volatility drift
    projected_prices = last_price * np.exp(np.cumsum(drift + forecast_vol * np.random.standard_normal(forecast_horizon)))
    
    df_fc = pd.DataFrame({'Close': projected_prices}, index=future_dates)
    full_series = pd.concat([hist_data[['Close']].tail(100), df_fc])

    # --- TABBED VIEW ---
    tab_fc, tab_strat = st.tabs(["ðŸ”® 1-Year Forecast", "ðŸ§ª Strategy Backtest & Signals"])

    with tab_fc:
        st.subheader(f"1-Year Price Path Projection ({sel_stock})")
        fig_fc = go.Figure()
        fig_fc.add_trace(go.Scatter(x=hist_data.tail(100).index, y=hist_data.tail(100)['Close'], name="Actual Price", line=dict(color="gray")))
        fig_fc.add_trace(go.Scatter(x=df_fc.index, y=df_fc['Close'], name="GARCH Projected", line=dict(color="#3b82f6", width=3)))
        fig_fc.update_layout(template="plotly_dark", paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)')
        st.plotly_chart(fig_fc, use_container_width=True)
        st.info("The projection above uses GARCH(1,1) volatility clusters to simulate the next 252 days of price movement.")

    with tab_strat:
        # --- 2. STRATEGY ENGINE ---
        def apply_strat(df):
            # SMA 20/50
            df['SMA20'] = df['Close'].rolling(20).mean()
            df['SMA50'] = df['Close'].rolling(50).mean()
            df['SMA_Sig'] = np.where(df['SMA20'] > df['SMA50'], 1, 0)
            
            # RSI
            delta = df['Close'].diff()
            gain = (delta.where(delta > 0, 0)).rolling(14).mean()
            loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
            rs = gain / (loss + 1e-9)
            df['RSI'] = 100 - (100 / (1 + rs))
            df['RSI_Sig'] = np.where(df['RSI'] < 30, 1, np.where(df['RSI'] > 70, 0, np.nan))
            df['RSI_Sig'] = df['RSI_Sig'].ffill().fillna(0)
            
            # Golden Cross (50/200) - Using hist + forecast to have enough data
            df['SMA200'] = df['Close'].rolling(200).mean()
            df['Golden_Sig'] = np.where(df['SMA50'] > df['SMA200'], 1, 0)
            
            return df

        # Combine historical tail with forecast to calculate indicators
        analysis_df = pd.concat([hist_data[['Close']].tail(250), df_fc]).copy()
        analysis_df = apply_strat(analysis_df)
        forecast_results = analysis_df.loc[df_fc.index]

        # Performance Table
        perf = []
        for s, name in [('SMA_Sig', 'SMA 20/50'), ('RSI_Sig', 'RSI Tactical'), ('Golden_Sig', 'Golden Cross')]:
            ret = (forecast_results['Close'].pct_change() * forecast_results[s].shift(1)).sum()
            trades = forecast_results[s].diff().abs().sum()
            perf.append({"Strategy": name, "Expected Return": f"{ret:.2%}", "Trades": int(trades)})
        
        st.subheader("Strategy Performance on Forecasted Data")
        st.table(pd.DataFrame(perf))

        # --- 3. SIGNAL CHARTS ---
        st.subheader("Strategy Buy/Sell Visualization")
        
        selected_viz = st.selectbox("Select Strategy to Visualize", ["SMA 20/50", "RSI Tactical", "Golden Cross"])
        
        fig_sig = go.Figure()
        fig_sig.add_trace(go.Scatter(x=forecast_results.index, y=forecast_results['Close'], name="Price", line=dict(color="white", opacity=0.3)))
        
        sig_col = 'SMA_Sig' if selected_viz == "SMA 20/50" else 'RSI_Sig' if selected_viz == "RSI Tactical" else 'Golden_Sig'
        
        # Buy Signals
        buys = forecast_results[forecast_results[sig_col].diff() == 1]
        sells = forecast_results[forecast_results[sig_col].diff() == -1]
        
        fig_sig.add_trace(go.Scatter(x=buys.index, y=buys['Close'], mode='markers', name='Buy', marker=dict(symbol='triangle-up', size=12, color='#00ff00')))
        fig_sig.add_trace(go.Scatter(x=sells.index, y=sells['Close'], mode='markers', name='Sell', marker=dict(symbol='triangle-down', size=12, color='#ff0000')))
        
        fig_sig.update_layout(template="plotly_dark", title=f"Buy/Sell Entry Points: {selected_viz}")
        st.plotly_chart(fig_sig, use_container_width=True)

else:
    st.error("Select a valid stock.")
