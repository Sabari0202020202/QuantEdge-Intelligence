# -*- coding: utf-8 -*-
"""QuantEdge Intelligence

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkmpljoOIvjbKUjTAM0G8OCGRZI-inXT
"""


import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from datetime import datetime, timedelta

# --- LIGHT THEME UI ---
st.set_page_config(page_title="QuantPro Advisor", layout="wide")
st.markdown("""
    <style>
    .stApp { background-color: #f8fafc; color: #1e293b; }
    [data-testid="stMetricValue"] { color: #1e3a8a !important; font-weight: 800; }
    [data-testid="metric-container"] { 
        background-color: #ffffff; border: 1px solid #e2e8f0; 
        border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .valuation-card { 
        padding: 20px; border-radius: 12px; background-color: #ffffff; 
        border: 1px solid #e2e8f0; border-top: 4px solid #2563eb; 
        margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }
    .status-undervalued { color: #16a34a; font-weight: bold; }
    .status-overvalued { color: #dc2626; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# --- ASSET UNIVERSE ---
STOCKS = ["RELIANCE.NS", "TCS.NS", "HDFCBANK.NS", "INFY.NS", "SBIN.NS", "ICICIBANK.NS", "TATAMOTORS.NS"]

# --- SIDEBAR CONTROLS ---
st.sidebar.title("ðŸ› ï¸ Settings")
sel_stock = st.sidebar.selectbox("Select Asset", STOCKS)
lookback = st.sidebar.slider("Timeframe (Years)", 1, 15, 5)
rf_rate = st.sidebar.number_input("Risk Free Rate %", value=7.1) / 100

# --- DATA ENGINE ---
@st.cache_data
def get_full_data(ticker, yrs):
    start = datetime.now() - timedelta(days=yrs*365 + 300) # Extra buffer for 200MA
    df = yf.download([ticker, "^NSEI", "^NSEBANK"], start=start.strftime('%Y-%m-%d'))['Close']
    if isinstance(df.columns, pd.MultiIndex):
        df.columns = df.columns.get_level_values(1)
    df = df.dropna(subset=[ticker]).ffill()
    return df, df.index[0]

data, listing_date = get_full_data(sel_stock, lookback)

if data is not None:
    # INITIALIZE TABS FIRST
    tab1, tab2 = st.tabs(["ðŸ’Ž Valuation & Market", "ðŸ—ï¸ Structural Strength"])

    # --- TAB 1: VALUATION ENGINE ---
    with tab1:
        st.title(f"Valuation: {sel_stock}")
        returns = data.pct_change().dropna()
        avg_ret = returns[sel_stock].mean() * 252
        
        # CAPM / Beta
        beta = (returns.cov().loc[sel_stock, "^NSEI"] * 252) / (returns["^NSEI"].var() * 252)
        mkt_ret = returns["^NSEI"].mean() * 252
        capm_exp = rf_rate + beta * (mkt_ret - rf_rate)
        
        # Display Metrics
        m1, m2, m3 = st.columns(3)
        m1.metric("Avg Annual Return", f"{avg_ret:.2%}")
        m2.metric("Market Beta", f"{beta:.2f}")
        m3.metric("Exp. Return (CAPM)", f"{capm_exp:.2%}")

        # Performance Graph
        cum_ret = (1 + returns).cumprod()
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=cum_ret.index, y=cum_ret[sel_stock], name="Stock", line=dict(color='#2563eb', width=3)))
        fig.add_trace(go.Scatter(x=cum_ret.index, y=cum_ret['^NSEI'], name="Nifty 50", line=dict(color='#94a3b8', dash='dot')))
        fig.update_layout(template="plotly_white", height=400)
        st.plotly_chart(fig, use_container_width=True)

    # --- TAB 2: TECHNICAL DNA ---
    with tab2:
        st.title(f"Price Structure: {sel_stock}")
        
        # Calculations
        data['MA50'] = data[sel_stock].rolling(50).mean()
        data['MA200'] = data[sel_stock].rolling(200).mean()
        last_price = data[sel_stock].iloc[-1]
        
        # A. TREND FILTER
        st.subheader("1. The Institutional Filter (Moving Averages)")
        c1, c2, c3 = st.columns(3)
        
        with c1:
            status = "âœ… BULLISH" if last_price > data['MA200'].iloc[-1] else "âŒ BEARISH"
            st.metric("Trend vs 200-Day MA", status)
        with c2:
            is_golden = data['MA50'].iloc[-1] > data['MA200'].iloc[-1]
            st.metric("50/200 MA Cross", "ðŸ”¥ GOLDEN" if is_golden else "â„ï¸ DEATH")
        with c3:
            dist_high = (last_price / data[sel_stock].max()) - 1
            st.metric("Near 52-Wk High", f"{dist_high:.2%}")

        # B. SUPPORT & RESISTANCE
        st.subheader("2. Price Memory (S/R Levels)")
        res = data[sel_stock].tail(20).max()
        supp = data[sel_stock].tail(20).min()
        
        fig_tech = go.Figure()
        fig_tech.add_trace(go.Scatter(x=data.tail(300).index, y=data[sel_stock].tail(300), name="Price", line=dict(color='#1e3a8a')))
        fig_tech.add_trace(go.Scatter(x=data.tail(300).index, y=data['MA200'].tail(300), name="200 MA", line=dict(color='#dc2626')))
        fig_tech.add_hline(y=res, line_dash="dash", line_color="green", annotation_text="Resistance")
        fig_tech.add_hline(y=supp, line_dash="dash", line_color="red", annotation_text="Support")
        fig_tech.update_layout(template="plotly_white", height=450)
        st.plotly_chart(fig_tech, use_container_width=True)
        

        # C. RELATIVE STRENGTH
        st.subheader("3. Relative Strength vs Nifty")
        stock_30 = (data[sel_stock].iloc[-1] / data[sel_stock].iloc[-22]) - 1
        nifty_30 = (data['^NSEI'].iloc[-1] / data['^NSEI'].iloc[-22]) - 1
        rs = stock_30 - nifty_30
        
        if rs > 0:
            st.success(f"ðŸ’ª Stock is OUTPERFORMING the market by {rs:.2%} over the last 22 days.")
        else:
            st.error(f"âš ï¸ Stock is UNDERPERFORMING the market by {rs:.2%} over the last 22 days.")

        # D. VOLATILITY/DRAWDOWN
        st.subheader("4. Volatility & Risk of Ruin")
        rolling_max = data[sel_stock].cummax()
        drawdown = (data[sel_stock] - rolling_max) / rolling_max
        max_dd = drawdown.min()
        
        st.metric("Historical Max Drawdown", f"{max_dd:.2%}")
        
        if abs(max_dd) > 0.30:
            st.warning("Brutal Volatility: This stock is prone to sharp, painful corrections.")

else:
    st.error("Could not fetch data.")





