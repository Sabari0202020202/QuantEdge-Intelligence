# -*- coding: utf-8 -*-
"""QuantEdge Intelligence

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gkmpljoOIvjbKUjTAM0G8OCGRZI-inXT
"""
import streamlit as st
import yfinance as yf
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from arch import arch_model # Use 'pip install arch'
from datetime import datetime

# --- CONFIG & THEME ---
st.set_page_config(page_title="QuantInsight India", layout="wide")

st.markdown("""
    <style>
    .stApp { background-color: #050a14; color: #ffffff; }
    [data-testid="stMetricValue"] { color: #ffffff !important; font-weight: 800; }
    [data-testid="metric-container"] { 
        background-color: #111827; 
        border: 1px solid #3b82f6; 
        border-radius: 8px; 
    }
    .stTabs [data-baseweb="tab-list"] { gap: 24px; }
    .stTabs [data-baseweb="tab"] { color: #94a3b8; }
    .stTabs [data-baseweb="tab-highlight"] { background-color: #3b82f6; }
    </style>
    """, unsafe_allow_html=True)

# --- STOCK LIST DATA ---
INDIAN_STOCKS = {
    "RELIANCE.NS": "Reliance Industries", "TCS.NS": "TCS", "HDFCBANK.NS": "HDFC Bank",
    "INFY.NS": "Infosys", "ICICIBANK.NS": "ICICI Bank", "SBIN.NS": "SBI",
    "BHARTIARTL.NS": "Bharti Airtel", "LICI.NS": "LIC", "ITC.NS": "ITC",
    "HINDUNILVR.NS": "HUL", "ADANIENT.NS": "Adani Ent", "TATASTEEL.NS": "Tata Steel"
    # Add more as needed
}

# --- FUNCTIONS ---
@st.cache_data
def get_data(ticker):
    stock = yf.download(ticker, start="2010-01-01")
    nifty = yf.download("^NSEI", start="2010-01-01")
    # Clean multi-index
    stock.columns = [c[0] if isinstance(c, tuple) else c for c in stock.columns]
    nifty.columns = [c[0] if isinstance(c, tuple) else c for c in nifty.columns]
    return stock, nifty

def calculate_metrics(df):
    results = {}
    for period, days in [("1Y", 252), ("2Y", 504), ("3Y", 756), ("5Y", 1260), ("MAX", len(df))]:
        sub = df.tail(days)
        ret = (sub['Close'].iloc[-1] / sub['Close'].iloc[0]) - 1
        vol = sub['Close'].pct_change().std() * np.sqrt(252)
        results[period] = {"Return": f"{ret:.2%}", "Risk (Vol)": f"{vol:.2%}"}
    return pd.DataFrame(results).T

def run_backtest(df, strategy_type, params):
    temp = df[['Close']].copy()
    temp['Returns'] = temp['Close'].pct_change()
    
    if strategy_type == "SMA":
        temp['Fast'] = temp['Close'].rolling(params[0]).mean()
        temp['Slow'] = temp['Close'].rolling(params[1]).mean()
        temp['Signal'] = np.where(temp['Fast'] > temp['Slow'], 1, 0)
    elif strategy_type == "RSI":
        delta = temp['Close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
        rs = gain / loss
        temp['RSI'] = 100 - (100 / (1 + rs))
        temp['Signal'] = np.where(temp['RSI'] < params[0], 1, 0) # Buy when oversold
        
    temp['Strat_Ret'] = temp['Signal'].shift(1) * temp['Returns']
    temp['Strat_Ret'] = temp['Strat_Ret'].fillna(0)
    
    cum_ret = (1 + temp['Strat_Ret']).prod() - 1
    annual_std = temp['Strat_Ret'].std() * np.sqrt(252)
    sharpe = (temp['Strat_Ret'].mean() * 252) / annual_std if annual_std != 0 else 0
    trades = (temp['Signal'].diff().abs() == 1).sum()
    
    return cum_ret, annual_std, sharpe, trades

# --- APP FLOW ---
st.title("ðŸ›ï¸ Institutional-Grade Stock Intelligence")

selected_stock = st.selectbox("Search & Select Indian Stock", options=list(INDIAN_STOCKS.keys()), 
                              format_func=lambda x: f"{INDIAN_STOCKS[x]} ({x})")

data, nifty = get_data(selected_stock)

if data is not None:
    tab1, tab2, tab3 = st.tabs(["ðŸ“‰ Market DNA", "ðŸ§ª Strategy Backtesting", "ðŸ“‹ Risk Report"])

    # --- TAB 1: THE PULSE & GARCH ---
    with tab1:
        st.subheader("GARCH(1,1) Volatility Forecast")
        returns = 100 * data['Close'].pct_change().dropna()
        model = arch_model(returns, vol='Garch', p=1, q=1)
        res = model.fit(disp="off")
        forecast = res.forecast(horizon=5)
        next_vol = np.sqrt(forecast.variance.values[-1, :]) * np.sqrt(252) / 10 # Scaled back
        
        c1, c2 = st.columns(2)
        c1.metric("Predicted Volatility (Next 5 Days)", f"{next_vol[0]:.2f}%")
        
        # Cumulative Comparison
        st.subheader("Relative Performance: Stock vs Nifty 50")
        fig = go.Figure()
        fig.add_trace(go.Scatter(x=data.index, y=(1+data['Close'].pct_change()).cumprod(), name=selected_stock, line=dict(color="#3b82f6")))
        fig.add_trace(go.Scatter(x=nifty.index, y=(1+nifty['Close'].pct_change()).cumprod(), name="Nifty 50", line=dict(color="#94a3b8", dash='dot')))
        fig.update_layout(template="plotly_dark", height=400)
        st.plotly_chart(fig, use_container_width=True)

    # --- TAB 2: THE PLAYBOOK (BACKTESTING) ---
    with tab2:
        st.subheader("Automated Strategy Performance (Long Only)")
        
        strategies = [
            ("SMA Crossover", "SMA", [20, 50], "Short Term"),
            ("Golden Cross", "SMA", [50, 200], "Long Term"),
            ("RSI Mean Reversion", "RSI", [30], "Oversold")
        ]
        
        bt_results = []
        for name, stype, params, horizon in strategies:
            ret, risk, sharpe, trades = run_backtest(data, stype, params)
            bt_results.append({
                "Strategy": name, "Horizon": horizon, "Exp. Return": f"{ret:.2%}",
                "Risk": f"{risk:.2%}", "Sharpe": round(sharpe, 2), "Trades": trades
            })
        
        st.table(pd.DataFrame(bt_results))
        

    # --- TAB 3: RISK REPORT ---
    with tab3:
        st.subheader("Historical Risk & Return Profile")
        st.dataframe(calculate_metrics(data), use_container_width=True)
        
        st.subheader("Anomaly Detection (Z-Score)")
        data['Z'] = (data['Close'].pct_change() - data['Close'].pct_change().mean()) / data['Close'].pct_change().std()
        anomalies = data[data['Z'].abs() > 3]
        st.write(f"Detected **{len(anomalies)}** extreme events (3rd standard deviation) in the last 15 years.")

else:
    st.error("Data fetch failed. Please check your internet or ticker.")
